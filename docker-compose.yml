---
version: '3.8'
services:
 
  arxiv-train:  &arxiv_base
    image: paper2code/arxiv-qa:cpu-latest
    container_name: ${NAMESPACE}-train
    build:
      context: ./services/server
      dockerfile: Dockerfile
    depends_on:
    - elasticsearch
    networks:
    - internal
    volumes:
    - arxiv-data:/opt/data
    - ./services/server:/opt/service
    command: ["--train"]

  arxiv-qa:
    <<: *arxiv_base
    container_name: ${NAMESPACE}-server
    environment:
    - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
    networks:
    - internal
    - web
    ports:
    - 5018:5018
    command: ["--port", "5018", "--host", "0.0.0.0"]

  arxiv-tg:
    image: paper2code/arxiv-tg:latest-py3-slim
    container_name: ${NAMESPACE}-telegram
    environment:
    - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
    build:
      context: ./services/telegram
      dockerfile: Dockerfile
    volumes:
    - ./services/telegram:/opt/service
    command: ["python3", "server.py"]

  arxiv-meta:
    image: paper2code/gsutil:4.9-alpine3.12
    container_name: ${NAMESPACE}-gsutil
    build:
      context: ./services/gsutil
      dockerfile: Dockerfile
    volumes:
    - arxiv-data:/opt/data
    command: ["cp", "-n", "gs://arxiv-dataset/metadata-v5/arxiv-metadata-oai.json", "."]

  elasticsearch:
    image: elasticsearch:7.6.2
    container_name: ${NAMESPACE}-elasticsearch
    networks:
    - internal
    environment:
    - discovery.type=single-node
    volumes:
    - es-data:/usr/share/elasticsearch/data
    ulimits:
      nproc: 65535
      nofile:
         soft: 65535
         hard: 65535
      memlock:
        soft: -1
        hard: -1
    restart: unless-stopped

networks:
  internal:
    driver: bridge
  web:
    external: true

volumes:
  arxiv-data:
  es-data: